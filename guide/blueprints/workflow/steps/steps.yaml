# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

-
  section_name: Workflow Control
  section_intro: |
    The first group of built-in step types are those which control the flow of execution and local state within the workflow.

  steps:
    - name: let
      summary: An alias for `set-workflow-variable`.
      shorthand: '`let [ "trimmed" ] [ TYPE ] VARIABLE_NAME = VALUE`'

    - name: set-workflow-variable
      summary: Sets the value of a workflow internal variable. The step `let` is an alias for this.
      shorthand: '`set-workflow-variable ["trim"] ["merge" ["deep"] ["clean"]] ["wait"] [TYPE] VARIABLE_NAME = VALUE`'
      input: |
        * `variable`: a string being the workflow variable name or a map containing the `name` and optionally the `type`
          to coerce (needed e.g. if you want to set a bean registered type, or in shorthand to set an `integer`);
          the `name` can be of the form `x.key` if `x` is a map to set a `key` within it
        * `value`: the value to set, with some limited evaluation as described [here](../variables.md)
        * `trim`: whether the value should be trimmed after evaluation and prior to setting, removing whitespace
          and for complex types coerced from YAML or JSON processing only the last YAML document after a `---` line separator as described [here](../variables.md)
        * `merge`: indicates the value will be a space-separated list of values, with quotes significant, usually including `$(vars)`, which will be merged and
          set as the indicated variable; `type` must be specified; for maps, all values must be maps; 
          for lists and sets, any value is permitted and collection values are flattened (to insert a list as an entry in a list, it must be wrapped in another list using longhand syntax);
          if `trim` is specified, null or unresolvable values are ignored; if `clean` is specified, null entries (including key or value for maps) are removed;
          if `wait` is specified, unavailable values are waited on
        * `merge_deep`: whether to merge maps deeply, i.e. where the keys are identical the values should be maps and those maps are themselves merged deeply; 
          the value should be as per `merge` but containing maps only;
          the values to merge are not otherwise coerced so must be pre-transformed to the appropriate type 
        * `wait`: whether to block on expressions such as `entity.sensor.x` which are well-formed but not yet available
      output: the output from the previous step, or null if this is the first step

    - name: clear-workflow-variable
      summary: Clears the value of a workflow internal variable.
      shorthand: '`clear-workflow-variable [TYPE] VARIABLE_NAME`'
      input: |
        * `variable`: a string being the workflow variable name or a map containing the `name`
             of the workflow variable which should be cleared
      output: the output from the previous step, or null if this is the first step

    - name: return
      summary: |
        Returns an indicated value and specifies that the workflow should end,
        essentially equivalent to `{ type: no-op, output: VALUE, next: end }`.
      shorthand: '`return VALUE`'
      input: |
        * `value`: the value to return
      output: the value indicated

    - name: wait
      summary: |
        Waits for a value which might not yet be resolved, or a task which might not have finished,
        optionally setting the value or the task's result to a workflow variable.
      shorthand: '`wait [ [TYPE] VARIABLE_NAME = ] [ "task" ] VALUE`'
      input: |
        * `variable`: a string being the workflow variable name or a map containing the `name` and optionally the `type`
             to coerce (needed e.g. if you want to set a bean registered type, or in shorthand to set an `integer`)
        * `task`: boolean to indicate that value should be treated as a task or task ID to wait on and take its result
        * `value`: the expression to wait on and optionally set
      output: |
        the value once available if a `variable` is not being set,
        or if a variable is being set the output from the previous step or null if this is the first step

    - name: fail
      summary: Fails the workflow, throwing an exception which can be handled by an `on-error` block or returned to the user
      shorthand: '`fail [ "rethrow" ] [ "message" MESSAGE ]`'
      input: |
        * `message`: a string to report in the exception
        * `rethrow`: whether to include any error in scope (if being used within an `on-error` step)
      output: _none_ (throws exception)

    - name: retry
      summary: Retries from an appropriate point with a configurable delay and back-off
      shorthand: '`retry [ "replay" ] [ "from" NEXT ] [ "limit" LIMIT_COUNT [ "in" LIMIT_TIME ] ] [ "backoff" BACKOFF ] [ "timeout" TIMEOUT ]`'
      input: |
        * `replay`: whether to replay or not; XXX 
        * `limit`: a list of limit definitions, e.g. `[ "10", "2 in 1 min" ]` to restrict to 10 retries total with
          an additional limit of 2 in any 1 minute period; as shorthand, per the syntax above, it takes one such limit
        * `backoff`: a specification of how to delay, of the form `INITIAL [ "increasing" FACTOR ] [ "up to" MAX ]`,
          where `INITIAL` is one or more durations applied to the respective iteration, and the last value applying to all
          unless `FACTOR` is supplied; `FACTOR` as either a number followed by `x` to multiply, a number followed by by `%` to add a percentage each time, 
          or a duration to increase linearly; and `MAX` to specify a maximum duration; for example,
          `backoff 1s 1s 10s` will retry after 1 second the first two times, then after 10 seconds on subsequent instances; 
          and `backoff 1s 2s backoff 3x max 1m` will retry after 1 second then 2s then 6s then 18s then 54s then 60s each subsequent time 
        * `key`: an optional key to identify related retries in a workflow; all retry blocks with the same `key` will share counts
          for the purpose of counting limits, although the limits themselves are as per the definition in each retry block
        * `next` and `timeout` per the [common](../common.md) step properties
      output: the output from the previous step, or null if this is the first step

    - name: goto
      summary: Moves execution to another step indicated by its ID
      shorthand: '`goto NEXT`'
      input: |
        * `next` per the [common](../common.md) step properties
      output: the output from the previous step, or null if this is the first step

    - name: workflow
      summary: |
        Runs nested workflow, optionally over an indicated target.
        This step type is described in more detail [here](../nested-workflow.md).
      input: |
        * `steps`: a list of steps to run, run in a separate context
        * `target`: an optional target specifier (see below)
      output: the output from the last step in the nested workflow

-
  section_name: External Actions
  section_intro: |
    The next group of step types are those which typically do the "real work" by interacting with
    external resources in the real world.

  steps:
    - name: container
      summary: |
        Runs a container with optional command and environment variables.
      shorthand: '`container IMAGE [ COMMAND ]`'
      input: |
        * `image`: the image to run
        * Optionally a command to pass to the image, at most one of:
            * `command`: a command or script as a string, to pass to bash to be run
            * `commands`: a list of commands to pass to bash to be run
            * `raw_command`: a list containing the base executable in the first entry and any arguments as additional entries
        * `env`: a map of string keys with values whose JSON is taken and passed to the command be executed
        * `exit_code`: the word `any`, a number, or a predicate DSL expression (e.g. `less-than: 32`)
                         to require of the exit status code from the command, defaulting to `0`
        * `pull_policy`: one of `IfNotPresent`, `Always`, or `Never`, whether to pull the image before running;
             defaults to `IfNotPresent`
        * `output_max_size`: by default output from commands is limited to 100k, truncating to keep the end; this can be increased or decreased,
          or disabled with `-1` (assuming Apache Brooklyn has sufficient memory to hold the data)
      output: |
        * `stdout`
        * `stderr`
        * `exit_code`


    - name: http
      summary: Sends an HTTPS (or HTTP) request and returns the response content and code.
      shorthand: '`http ENDPOINT`'
      input: |
        * `endpoint`: the URL to connect to, optionally omitting the protocol and slash prefix if `https://` is intended
             (e.g. just the host and any path); per URL standard any unusual characters such as query parameters should be URL-encoded,
             so if e.g. passing parameters containing spaces, `params` should be used instead of `host/path?param=${value}`
        * `query`: a map of query parameters to URL encode and add to the URL
        * `body`: an object to be serialized and sent as the body (or just set as body if it is an array of bytes)
        * `charset`: the character set to use to convert between byte arrays and strings for the request body and response content;
             not applied if `body` is already a byte array, and not applied to the `content_bytes` output;
             defaults to the system default
        * `status_code`: the word `any`, a number, or a predicate DSL expression to require of the response status code,
             defaulting to `{ less-than: 400, greater-than-or-equal-to: 200 }`
        * `headers`: a map of header key-values to set on the request
        * `method`: the HTTP method for the request, defaulting to `get`
        * `username` and `password`: credentials to set on the request, e.g. for Basic auth
             (other auth schemes can be implemented using `headers`)
        * `config`: allows configuration of HTTPS, specifically a map of booleans `laxRedirect`, `trustAll`, and `trustSelfSigned`;
             defaults to entity config or `brooklyn.properties` values of the same keys prefixed with
             `brooklyn.https.config.`, and otherwise defaulting to `false` for each for security;
             this allows e.g. configuration to work with self-signed hosts where the network is trusted
      output: |
        * `status_code`: integer status code, e.g. 200
        * `headers`: a map of header keys to a _list_ of values for that header on the response (as multiple values are permitted)
        * `content`: the content, converted to a string using `charset`
        * `content_bytes`: the content, as a raw byte array
        * `duration`: how long the request took

    - name: ssh
      summary: Runs a command over ssh.
      shorthand: '`ssh COMMAND`'
      input: |
        * `command`: the command to run
        * `env`: a map of string keys with values whose JSON is taken and passed to the command be executed
        * `exit_code`: the word `any`, a number, or a predicate DSL expression (e.g. `less-than: 32`)
        * `output_max_size`: by default output from commands is limited to 100k, truncating to keep the end; this can be increased or decreased,
          or disabled with `-1` (assuming Apache Brooklyn has sufficient memory to hold the data)

      #  [//]: # (* `endpoint`: an alternative endpoint &#40;format TODO&#41;; typically this is omitted and the SSH machine location of the entity is the target)
      #  [//]: # (* `key`: a private key to use for the connection to the endpoint &#40;TODO, again typically embedded in the SSH machine location of the entity&#41;)
      output: |
        * `stdout`
        * `stderr`
        * `exit_code`

    - name: winrm
      summary: Runs a command over winrm.
      shorthand: '`winrm COMMAND`'
      input: |
        * `command`: the command to run
        * `env`: a map of string keys with values whose JSON is taken and passed to the command be executed
        * `exit_code`: the word `any`, a number, or a predicate DSL expression (e.g. `less-than: 32`)
                         to require of the exit status code from the command, defaulting to `0`
        * `output_max_size`: by default output from commands is limited to 100k, truncating to keep the end; this can be increased or decreased,
          or disabled with `-1` (assuming Apache Brooklyn has sufficient memory to hold the data)

      #  [//]: # (* `endpoint`: an alternative endpoint &#40;format TODO&#41;; typically this is omitted and the SSH machine location of the entity is the target)
      #  [//]: # (* `key`: a private key to use for the connection to the endpoint &#40;TODO, again typically embedded in the SSH machine location of the entity&#41;)

      output: |
        * `stdout`
        * `stderr`
        * `exit_code`


    - name: ansible-ssh
      summary: |
        Runs a playbook via Ansible by SSHing to the VM under management.
        These playbooks will often target `localhost` but may target other servers.
      shorthand: '`ansible-ssh PLAYBOOK_NAME [ "from" PLAYBOOK_URL ]`'
      input: |
        * `playbook_name`: name of the playbook to run; required
        * `playbook_url`: URL for downloading the playbook; exactly one of this or `playbook_yaml` is required
        * `playbook_yaml`: YAML for the playbook, embedded in the step
        * `vars`: optional variables to pass to Ansible
        * `run_dir`: the directory on the target system where playbooks should be installed and run;
             defaults to an entity-specific folder
        * `install`: whether to install Ansible if necessary, defaults to `true`
        * `install_dir`: the directory on the target system from which Ansible should be downloaded and installed,
             if `install` is not false, defaults to an entity-specific folder
        * `env`: a map of string keys with values whose JSON is taken and passed to the command be executed
        * `exit_code`: the word `any`, a number, or a predicate DSL expression (e.g. `less-than: 32`)
                         to require of the exit status code from the command, defaulting to `0`
        * `output_max_size`: by default output from commands is limited to 100k, truncating to keep the end; this can be increased or decreased,
          or disabled with `-1` (assuming Apache Brooklyn has sufficient memory to hold the data)
      output: |
        * `stdout`
        * `stderr`
        * `exit_code`

-
  section_name: Application Models
  section_intro: |
    The next group of step types manipulate the application models in Brooklyn.

  steps:
    - name: invoke-effector
      summary: Invokes an effector.
      shorthand: '`invoke-effector EFFECTOR`'
      input: |
        * `effector`: the name of the effector to invoke
        * `entity`: optional entity or entity ID where the effector should be invoked
        * `args`: map of argument names to values to pass to the effector
      output: the returned object from the invoked effector

    - name: set-config
      summary: Sets the value of a config key on an entity.
      shorthand: '`set-config [TYPE] CONFIG_KEY_NAME = VALUE`'
      input: |
        * `config`: a string being the config key name or a map containing the `name` and
             optionally the `type` (defaulting to the declared type of the config key, if present, or to `Object`)
             and/or the `entity` where the config should be set (defaulting to the entity where the workflow is running)
        * `value`: the value to set
      output: the output from the previous step, or null if this is the first step

    - name: set-sensor
      summary: Sets the value of a sensor on an entity.
      shorthand: '`set-sensor [TYPE] SENSOR_NAME = VALUE`'
      input: |
        * `sensor`: a string being the sensor name or a map containing the `name` and
             optionally the `type` (defaulting to the declared type of the sensor, if present, or to `Object`)
             and/or the `entity` where the sensor should be set (defaulting to the entity where the workflow is running)
        * `value`: the value to set
      output: the output from the previous step, or null if this is the first step

    - name: clear-config
      summary: Clears the value of a config key on an entity.
      shorthand: '`clear-config [TYPE] CONFIG_KEY_NAME`'
      input: |
        * `config`: a string being the config key name or a map containing the `name` and
          optionally the `entity` where the config should be set (defaulting to the entity where the workflow is running)
      output: |
        the output from the previous step, or null if this is the first step

    - name: clear-sensor
      summary: Clears the value of a sensor on an entity.
      shorthand: '`clear-sensor [TYPE] SENSOR_NAME`'
      input: |
        * `sensor`: a string being the sensor name or a map containing the `name` and
          optionally the `entity` where the sensor should be cleared (defaulting to the entity where the workflow is running)
      output: the output from the previous step, or null if this is the first step


-
  section_name: General Purpose
  section_intro: |
    A few other miscellaneous step types don't fit into the other categories.
  steps:

    - name: log
      summary: Logs a message.
      shorthand: '`log MESSAGE`'
      input: |
        * `message`: the message to be logged
      output: the output from the previous step, or null if this is the first step

    - name: no-op
      summary: |
        Does nothing. It is mainly useful when setting a `next` point to jump to,
        optionally with a `condition`.
      shorthand: '`no-op`'
      input: _none_
      output: the output from the previous step, or null if this is the first step

    - name: sleep
      summary: Causes execution to pause for a specified duration.
      shorthand: '`sleep DURATION`'
      input: |
        * `duration`: how long to sleep for, e.g. `5s` for 5 seconds
      output: the output from the previous step, or null if this is the first step



